<%- include('../../partials/header') %>

<section class="content-block light-grey home-top">
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">Contracts Finder</h3>
        </div>
        <div class="panel-body">
          <div class="row mb-3">
            <div class="col-md-6">
              <button id="manualSearch" class="btn btn-success">
                <i class="bi bi-search"></i> Check for Updates
              </button>
              <button id="rateAll" class="btn btn-info">
                <i class="bi bi-star"></i> Rate All Contracts
              </button>
            </div>
            <div class="col-md-6 text-right">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="showMatchesOnly">
                <label class="form-check-label" for="showMatchesOnly">
                  Show Matches Only
                </label>
              </div>
              <small class="text-muted">Last updated: <span id="lastUpdated">-</span></small>
            </div>
          </div>
          
          <!-- Status Info Box -->
          <div id="statusInfoBox" class="alert" style="display: none; margin-bottom: 20px;">
            <div class="row">
              <div class="col-md-8">
                <span id="searchStatus"></span>
              </div>
              <div class="col-md-4 text-right">
                <button type="button" class="close" id="closeStatusBox" aria-label="Close">
                  <span aria-hidden="true">&times;</span>
                </button>
              </div>
            </div>
          </div>
          
          <table id="contractsTable" class="table table-striped table-bordered" style="width:100%">
            <thead>
              <tr>
                <th>Organisation</th>
                <th>Title</th>
                <th>Published Date</th>
                <th>Deadline</th>
                <th>Value Range</th>
                <th>AI Rating</th>
                <th>Reviewer Rating</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Data will be loaded via AJAX -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
</section>

<!-- DataTables CSS and JS -->
<link href="/lib/DataTables/datatables.min.css" rel="stylesheet" type="text/css">
<script src="/lib/DataTables/datatables.min.js"></script>


<script>
$(document).ready(function() {
  // Initialize DataTable
  var table = $('#contractsTable').DataTable({
    processing: true,
    serverSide: false, // Use client-side processing
    ajax: {
      url: '/contracts/api/data',
      type: 'GET',
      data: function(d) {
        d.showMatchesOnly = $('#showMatchesOnly').is(':checked');
      }
    },
    columns: [
      { data: 0 }, // Organisation
      { data: 1 }, // Title
      { data: 2 }, // Published Date
      { data: 3 }, // Deadline
      { data: 4 }, // Value Range
      { 
        data: 5, // AI Rating
        render: function(data, type, row) {
          if (type === 'display') {
            return data; // Return the HTML for display
          }
          return row[8]; // Return the numeric score for sorting/filtering
        }
      },
      { data: 6 }, // Reviewer Rating
      { 
        data: 7, // Actions
        orderable: false,
        searchable: false
      },
      { 
        data: 8, // Hidden rating score for sorting
        visible: false
      }
    ],
    responsive: true,
    pageLength: 25,
    order: [[5, 'desc']], // Sort by AI Rating descending (highest rated first)
    language: {
      search: "Search contracts:",
      lengthMenu: "Show _MENU_ contracts per page",
      info: "Showing _START_ to _END_ of _TOTAL_ contracts"
    }
  });

  // Manual search trigger
  $('#manualSearch').click(function() {
    var button = $(this);
    var originalText = button.text();
    
    button.prop('disabled', true).text('Checking for updates...');
    showStatusBox('info', '<i class="bi bi-hourglass"></i> Checking for contract updates...');
    
    $.ajax({
      url: '/contracts/search',
      method: 'POST',
      success: function(response) {
        if (response.success) {
          showStatusBox('success', '<i class="bi bi-check-circle"></i> Update check completed! Processed: ' + 
            response.result.processed + ', New: ' + response.result.new + ', Updated: ' + response.result.updated);
          table.ajax.reload();
          $('#lastUpdated').text(new Date().toLocaleString());
        } else {
          showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Update check failed: ' + response.error);
        }
      },
      error: function(xhr, status, error) {
        showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Update check failed: ' + error);
      },
      complete: function() {
        button.prop('disabled', false).text(originalText);
      }
    });
  });



  // Rate all contracts
  $('#rateAll').click(function() {
    var button = $(this);
    var originalText = button.text();
    
    button.prop('disabled', true).text('Rating...');
    showStatusBox('info', '<i class="bi bi-hourglass"></i> Rating contracts with AI (this may take several minutes)...');
    
    $.ajax({
      url: '/contracts/rate-all',
      method: 'POST',
      success: function(response) {
        if (response.success) {
          if (response.result.skipped) {
            showStatusBox('warning', '<i class="bi bi-info-circle"></i> Rating skipped: ' + response.message);
          } else {
            showStatusBox('success', '<i class="bi bi-check-circle"></i> Rating completed! Processed: ' + 
              response.result.processed + ', Rated: ' + response.result.rated + ', Errors: ' + response.result.errors);
          }
          table.ajax.reload();
          $('#lastUpdated').text(new Date().toLocaleString());
        } else {
          showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Rating failed: ' + response.error);
        }
      },
      error: function(xhr, status, error) {
        showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Rating failed: ' + error);
      },
      complete: function() {
        button.prop('disabled', false).text(originalText);
      }
    });
  });

  // Show matches only checkbox
  $('#showMatchesOnly').change(function() {
    table.ajax.reload();
  });

  // Handle individual contract rating
  $('#contractsTable').on('click', '.rate-single', function() {
    var button = $(this);
    var itemId = button.data('item-id');
    var originalText = button.html();
    
    button.prop('disabled', true).html('<i class="bi bi-hourglass"></i> Rating...');
    
    $.ajax({
      url: '/contracts/rate/' + itemId,
      method: 'POST',
      success: function(response) {
        if (response.success) {
          // Update the button to show re-rate
          button.removeClass('btn-info').addClass('btn-warning');
          button.html('<i class="bi bi-star"></i> Re-rate');
          
          // Show success message
          showStatusBox('success', '<i class="bi bi-check-circle"></i> Contract rated successfully!');
          
          // Reload the table to update the rating display
          table.ajax.reload();
        } else {
          showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Rating failed: ' + response.error);
        }
      },
      error: function(xhr, status, error) {
        showStatusBox('danger', '<i class="bi bi-exclamation-triangle"></i> Rating failed: ' + error);
      },
      complete: function() {
        button.prop('disabled', false);
      }
    });
  });

  // Update last updated time on page load
  $('#lastUpdated').text(new Date().toLocaleString());
  
  // Helper function to show status box
  function showStatusBox(type, message) {
    var statusBox = $('#statusInfoBox');
    var statusText = $('#searchStatus');
    
    // Remove all alert classes and add the appropriate one
    statusBox.removeClass('alert-info alert-success alert-warning alert-danger')
             .addClass('alert-' + type);
    
    // Set the message
    statusText.html(message);
    
    // Show the box
    statusBox.show();
    
    // Auto-hide success messages after 5 seconds
    if (type === 'success') {
      setTimeout(function() {
        hideStatusBox();
      }, 5000);
    }
  }
  
  // Helper function to hide status box
  function hideStatusBox() {
    $('#statusInfoBox').hide();
  }
  
  // Close status box when X is clicked
  $('#closeStatusBox').click(function() {
    hideStatusBox();
  });
});
</script>

<%- include('../../partials/footer') %> 